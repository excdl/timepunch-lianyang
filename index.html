<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <base target="_top" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

  <title>éŠ·è²¨å–®ç³»çµ±</title>
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      margin: 20px;
      color: #333;
      background-color: #f9f9f9;
      font-size: 14px;
    }
    h2, h3 {
      margin-top: 0;
      color: #2c3e50;
    }
    label {
      font-size: 18px;
      font-weight: bold;
      margin-bottom: 0;
      display: inline-flex;
      align-items: center;
      width: 90px;
      white-space: nowrap;
    }
    input, select, textarea {
      font-size: 14px;
      padding: 6px 8px;
      box-sizing: border-box;
    }
    textarea {
      white-space: normal;
      resize: vertical;
      font-size: 16.8px;
    }
    button {
      background-color: #3498db;
      color: white;
      border: none;
      border-radius: 4px;
      padding: 0.4em 1em;
      margin: 5px 5px 5px 0;
      cursor: pointer;
      font-weight: bold;
      transition: background-color 0.2s;
      white-space: normal;
      font-size: inherit;
      display: inline-block;
      min-width: 80px;
      max-width: 100%;
      text-align: center;
    }
    button:hover {
      background-color: #2980b9;
    }
    hr {
      border: none;
      border-top: 1px solid #ddd;
      margin: 20px 0;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      table-layout: fixed;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: center;
      white-space: normal;
      word-break: break-word;
      overflow: hidden;
      font-size: 18px;
      line-height: 1.4;
    }
    th {
      background-color: #f0f0f0;
      vertical-align: middle;
      font-size: 18px;
    }
    #productSearchResults {
      border: 1px solid #ccc;
      max-height: 200px;
      overflow-y: auto;
      margin-top: 2px;
      width: 100%;
      background: white;
      position: absolute;
      z-index: 10;
      font-size: 14px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.15);
      border-radius: 4px;
    }
    #productSearchResults .item {
      padding: 8px 10px;
      cursor: pointer;
      border-bottom: 1px solid #eee;
      line-height: 1.4;
    }
    #productSearchResults .item:hover {
      background-color: #f0f0f0;
    }
    #productSearchResults .item-title {
      font-weight: bold;
      font-size: 16px;
    }
    #productSearchResults .item-sub {
      font-size: 13px;
      color: #666;
    }
    .item-info {
      flex: 1;
    }
    .item-title {
      font-weight: bold;
      font-size: 16px;
    }
    .item-sub {
      font-size: 13px;
      color: #666;
    }
    .item-img {
      width: 50px;
      height: 50px;
      object-fit: cover;
      border-radius: 4px;
    }
    input.qty-input {
      width: 50px;
      font-size: 16.8px;
      padding: 6px 10px;
      border: 1px solid #ccc;
      border-radius: 4px;
      white-space: nowrap;
    }
    .break-line {
      display: block;
      margin-top: 4px;
      margin-bottom: 8px;
      font-weight: normal;
    }
    .flex-row {
      display: flex;
      gap: 20px;
      align-items: center;
      flex-wrap: wrap;
      margin-bottom: 10px;
    }
    .flex-row > div {
      flex: 1;
      min-width: 150px;
    }
    .field-group {
      display: flex;
      align-items: center;
      gap: 6px;
      width: 100%;
    }
    #clientAddress-container {
      display: flex;
      align-items: flex-start;
      gap: 6px;
      margin-bottom: 10px;
      max-width: 600px;
    }
    #clientAddress-container label {
      width: 90px;
      font-weight: bold;
      margin-bottom: 0;
      padding-top: 6px;
      white-space: nowrap;
      font-size: 18px;
    }
    #clientAddress {
      flex: 1;
      font-size: 16.8px;
      padding: 6px 8px;
      resize: vertical;
      box-sizing: border-box;
    }
    input[type="text"],
    input[type="email"],
    input[type="number"],
    input[type="date"] {
      flex: 1;
    }
    .field-group.product-field {
      width: 250px;
    }
    input.qty-small {
      width: 60px;
    }

    /* åˆ—å°æ¨£å¼èª¿æ•´ï¼ˆå¯åœ¨é€™è£¡è¦†è“‹å¿…è¦æ¨£å¼ï¼‰ */
    @media print {
      button, input[type="text"], input[type="email"], input[type="number"], input[type="date"], .search-area, #orderResultMessage, #orderResultData {
        display: none !important;
      }
      /* ä½ å¯ä»¥å†å®šç¾©åˆ—å°è¡¨æ ¼ã€å­—é«”å¤§å°ç­‰ */
    }
  </style>
</head>
<body>
  <body>
  <h2 class="page-title">ğŸ›’ éŠ·è²¨å–®ç³»çµ±</h2>

  <div style="margin-bottom: 10px;">
    <button onclick="createNewOrder()">â• è¨‚å–®(F1)</button>
  </div>

  <div class="flex-row" style="margin-bottom: 20px;">
    <div class="field-group">
      <label for="orderIdDisplay">è¨‚å–®è™Ÿç¢¼ï¼š</label>
      <input type="text" id="orderIdDisplay" readonly style="width:200px;" />
    </div>
    <div class="field-group">
      <label for="orderDateInput">æ—¥æœŸï¼š</label>
      <input type="date" id="orderDateInput" />
    </div>
    <div class="field-group">
      <label for="creatorInput">è£½å–®äººå“¡ï¼š</label>
      <input type="text" id="creatorInput" placeholder="è¼¸å…¥è£½å–®äººå“¡" autocomplete="off" list="creatorList" />
      <datalist id="creatorList"></datalist>
    </div>
  </div>
</body>

<style>
.page-title {
  text-align: center;
  font-size: 200%;
  font-weight: bold;
  margin: 10px 0 20px;
}
</style>
  

 <div>
  <div class="flex-row">
    <div class="field-group">
      <label for="clientInput">å®¢æˆ¶åç¨±ï¼š</label>
      <input type="text" id="clientInput" placeholder="è¼¸å…¥é—œéµå­—æœå°‹å®¢æˆ¶" autocomplete="off" list="clientList" />
      <datalist id="clientList"></datalist>
    </div>
    <!-- âœ… æ–°å¢ï¼šç·¨è¼¯å®¢æˆ¶è³‡æ–™æŒ‰éˆ• -->
    <div class="field-group" style="margin-left:10px;">
      <button id="editClientBtn" type="button" onclick="toggleClientEdit()">âœï¸ ç·¨è¼¯å®¢æˆ¶è³‡æ–™(F3)</button>
    </div>
  </div>

  <div class="flex-row">
    <div class="field-group">
      <label for="invoiceNumber">çµ±ä¸€ç·¨è™Ÿï¼š</label>
      <input type="text" id="invoiceNumber" />
    </div>
    <div class="field-group">
      <label for="email">E-MAILï¼š</label>
      <input type="email" id="email" />
    </div>
  </div>

  <div class="flex-row">
    <div class="field-group">
      <label for="contact">è¯çµ¡äººï¼š</label>
      <input type="text" id="contact" />
    </div>
    <div class="field-group">
      <label for="mobile">æ‰‹æ©Ÿè™Ÿç¢¼ï¼š</label>
      <input type="text" id="mobile" />
    </div>
    <div class="field-group">
      <label for="tel">å…¬å¸é›»è©±ï¼š</label>
      <input type="text" id="tel" />
    </div>
  </div>

  <div id="clientAddress-container">
    <label for="clientAddress">åœ°å€ï¼š</label>
    <textarea id="clientAddress" rows="2" cols="50"></textarea>
  </div>

  <div class="flex-row" style="margin-top:10px;">
    <div class="field-group">
      <label for="salesperson">æ¥­å‹™äººå“¡ï¼š</label>
      <input type="text" id="salesperson" />
    </div>
    <div class="field-group">
      <label for="tripNumber">è»Šæ¬¡ï¼š</label>
      <input type="text" id="tripNumber" />
    </div>
  </div>
</div>

<h3>é¸æ“‡å•†å“(F2)</h3> 
<div class="flex-row">
  <input type="text" id="productInput" placeholder="è¼¸å…¥é—œéµå­—æœå°‹å•†å“" autocomplete="off" list="productList">
  <datalist id="productList"></datalist>

  <input type="number" id="qty" class="qty-small" placeholder="æ•¸é‡" min="1" value="1">

  <input type="text" id="unitSelect" list="unitList" placeholder="å–®ä½" style="width:100%;">
  <datalist id="unitList">
    <option value="å€‹"></option>
    <option value="åŒ…"></option>
    <option value="ç›’"></option>
    <option value="æ–¤"></option>
    <option value="å…¬æ–¤"></option>
    <option value="å°æ–¤"></option>
    <option value="ç“¶"></option>
    <option value="ç½"></option>
    <option value="è¢‹"></option>
    <option value="åŒ…è£"></option>
  </datalist>

  <button onclick="addSelectedProduct()">â•å•†å“(F12)</button>
</div>

<table>
  <thead>
    <tr>
      <th>å“å</th>
      <th>è¨‚è²¨æ•¸é‡</th>
      <th>å–®ä½</th>
      <th>å‡ºè²¨å–®åƒ¹</th>
      <th>å‡ºè²¨æ•¸é‡</th>
      <th>æ›ç®—æ•¸é‡</th>
      <th>æ›ç®—å–®ä½</th>
      <th>é‡‘é¡å°è¨ˆ</th>
      <th>æ“ä½œ</th>
    </tr>
  </thead>
  <tbody id="cartBody"></tbody>
</table>

<h3>ç¸½é‡‘é¡ (æœªæŠ˜æ‰£å‰)ï¼š<span id="rawTotal">0</span> å…ƒ</h3>

<div class="flex-row" style="margin-top:10px; align-items:center; gap:16px;">
  <div class="field-group">
    <label for="discount">æŠ˜æ‰£é‡‘é¡ï¼š</label>
    <input type="number" id="discount" value="0" min="0" />
  </div>
  <div class="field-group" style="display:flex; align-items:center; gap:8px;"> 
  <label>æ˜¯å¦æ‡‰ç¨…ï¼š</label>
  <input type="radio" name="taxable" id="taxable_yes" value="yes" checked onchange="renderCart()" />
  <label for="taxable_yes">æ‡‰ç¨…</label>
  <input type="radio" name="taxable" id="taxable_no" value="no" onchange="renderCart()" />
  <label for="taxable_no">å…ç¨…</label>

  <!-- ç¨…é‡‘æ”¹æˆåªè®€ input -->
  <label style="margin-left:16px; font-weight:600;">ç¨…é‡‘ï¼š</label>
  <input type="text" id="taxAmount" value="0" readonly style="width:80px; text-align:right;" /> å…ƒ
</div>
</div>
<h3>æŠ˜æ‰£å¾Œ + ç¨…é‡‘å¾Œç¸½é¡ï¼š<span id="grandTotal">0</span> å…ƒ</h3>


<div class="flex-row" style="margin-top: 10px;">
  <div class="field-group">
    <label for="paymentMethod">ä»˜æ¬¾æ–¹å¼ï¼š</label>
    <input type="text" id="paymentMethod" />
  </div>
  <div class="field-group">
    <label for="paymentDays">æœˆçµå¤©æ•¸ï¼š</label>
    <input type="number" id="paymentDays" min="0" />
  </div>
  <div class="field-group">
    <label for="paymentDate">æœˆçµæ—¥æœŸï¼š</label>
    <input type="date" id="paymentDate" />
  </div>
</div>

<div class="flex-row" style="margin-top:20px;">
  <button onclick="copyOrder()">ğŸ“„ è¤‡è£½(F4)</button>
  <button onclick="deleteCurrentOrder()">ğŸ—‘ï¸ åˆªé™¤(F5)</button>
  <button onclick="resetForm()">âœ– æ¸…ç©º(F6)</button>
  <button onclick="printOrder()">ğŸ–¨ åˆ—å°(F7)</button>
  <button id="saveBtn" onclick="submitOrder()">âœ… å„²å­˜(F8)</button>

</div>
<hr>

<h3 class="search-area">ğŸ” æŸ¥è©¢è¨‚å–®(F9)</h3>
<div class="search-area">
  <input type="text" id="searchOrderId" placeholder="è«‹è¼¸å…¥è¨‚å–®ç·¨è™Ÿ" />
  <button onclick="searchOrder()">æŸ¥è©¢(F10)</button>
</div>

<div id="orderResultMessage" style="display:none;color:red;margin-top:10px;" class="search-area"></div>
<pre id="orderResultData" style="display:none; white-space: pre-wrap; background:#fff; border:1px solid #ccc; padding:10px; max-width:600px;" class="search-area"></pre>

<script>
  let products = [];
  let clients = [];
  let cart = [];
  let currentOrder = null;
  let editingIndex = null;
  
  // === âœ… æ–°å¢ï¼šæ§åˆ¶å®¢æˆ¶è³‡æ–™ç·¨è¼¯é–å®š ===
  let isClientEditable = false;
  const clientFieldIds = [
    "invoiceNumber",
    "contact",
    "mobile",
    "tel",
    "clientAddress",
    "salesperson",
    "tripNumber",
    "email"
  ];

  function setClientFieldsDisabled(disabled) {
    clientFieldIds.forEach(id => {
      const el = document.getElementById(id);
      if (el) el.disabled = disabled;
    });
  }

  function toggleClientEdit() {
    isClientEditable = !isClientEditable;
    setClientFieldsDisabled(!isClientEditable);

    const btn = document.getElementById("editClientBtn");
    if (isClientEditable) {
      btn.textContent = "ğŸ’¾ å®Œæˆç·¨è¼¯(F3)";
    } else {
      btn.textContent = "âœï¸ ç·¨è¼¯å®¢æˆ¶è³‡æ–™(F3)";
    }
  }

  document.addEventListener("DOMContentLoaded", () => {
    setClientFieldsDisabled(true);
  });

  // === è¨‚å–®å»ºç«‹ ===
  function createNewOrder() {
    google.script.run.withSuccessHandler(newId => {
      resetForm();
      document.getElementById('orderIdDisplay').value = newId;
      currentOrder = null;
    }).generateOrderId();
  }

  // === è¼‰å…¥å®¢æˆ¶è³‡æ–™ ===
  function loadClients() {
    google.script.run.withSuccessHandler(data => {
      clients = data;
      const datalist = document.getElementById('clientList');
      datalist.innerHTML = '';
      data.forEach(c => {
        const opt = document.createElement('option');
        opt.value = c.name;
        datalist.appendChild(opt);
      });
    }).getClients();
  }

  // === è¼‰å…¥å•†å“è³‡æ–™ ===
  function loadProducts() {
    google.script.run.withSuccessHandler(data => {
      products = data;
      const datalist = document.getElementById('productList');
      datalist.innerHTML = '';
      products.forEach(p => {
        const opt = document.createElement('option');
        opt.value = p.name;
        datalist.appendChild(opt);
      });
    }).getProducts();
  }

  // === å®¢æˆ¶åç¨±è¼¸å…¥äº‹ä»¶ ===
  document.getElementById('clientInput').addEventListener('input', e => {
    const val = e.target.value.trim().toLowerCase();
    const c = clients.find(c => c.name.toLowerCase() === val);
    if (c) {
      document.getElementById('invoiceNumber').value = c.invoiceNumber || '';
      document.getElementById('contact').value = c.contact || '';
      document.getElementById('mobile').value = c.mobile || '';
      document.getElementById('tel').value = c.tel || '';
      document.getElementById('clientAddress').value = c.address || '';
      document.getElementById('paymentMethod').value = c.paymentMethod || '';
      document.getElementById('paymentDays').value = c.paymentDays || '';

      if (c.paymentDate) {
        let d = c.paymentDate;
        if (d instanceof Date) {
          d = d.toISOString().slice(0,10);
        } else {
          d = d.replace(/\//g, '-');
          const parts = d.split('-');
          if (parts.length === 3) {
            d = parts[0] + '-' + parts[1].padStart(2,'0') + '-' + parts[2].padStart(2,'0');
          }
        }
        document.getElementById('paymentDate').value = d;
      } else {
        document.getElementById('paymentDate').value = '';
      }

      document.getElementById('salesperson').value = c.salesperson || '';
      document.getElementById('tripNumber').value = c.tripNumber || '';
      document.getElementById('email').value = c.email || '';
    } else {
      document.getElementById('invoiceNumber').value = '';
      document.getElementById('contact').value = '';
      document.getElementById('mobile').value = '';
      document.getElementById('tel').value = '';
      document.getElementById('clientAddress').value = '';
      document.getElementById('paymentMethod').value = '';
      document.getElementById('paymentDays').value = '';
      document.getElementById('paymentDate').value = '';
      document.getElementById('salesperson').value = '';
      document.getElementById('tripNumber').value = '';
      document.getElementById('email').value = '';
    }

    // === æ¯æ¬¡è¼¸å…¥å®¢æˆ¶å¾Œè‡ªå‹•é–å®šæ¬„ä½ ===
    setClientFieldsDisabled(true);
    isClientEditable = false;
    document.getElementById("editClientBtn").textContent = "âœï¸ ç·¨è¼¯å®¢æˆ¶è³‡æ–™";
  });

// ç•¶å•†å“åç¨±è¼¸å…¥æ™‚ï¼Œè‡ªå‹•å¸¶å‡ºå–®ä½ 
document.getElementById('productInput').addEventListener('input', function() {
  const productName = this.value.trim();
  const product = products.find(p => p.name === productName);
  const unitSelect = document.getElementById('unitSelect');

  if (unitSelect) {
    if (product) {
      unitSelect.value = product.unit;
    } else {
      unitSelect.value = '';
    }
  }
});

// æ–°å¢å•†å“åˆ°è³¼ç‰©è»Š
function addSelectedProduct() { 
  const productNameInput = document.getElementById('productInput');
  const productName = productNameInput.value.trim();
  const qty = parseFloat(document.getElementById('qty').value) || 0;
  const unitSelect = document.getElementById('unitSelect');
  const selectedUnit = unitSelect ? unitSelect.value.trim() : '';

  if (qty <= 0) {
    alert('æ•¸é‡å¿…é ˆå¤§æ–¼0');
    return;
  }

  const product = products.find(p => p.name === productName);
  if (!product) {
    alert('æ‰¾ä¸åˆ°å•†å“');
    return;
  }

  // å•†å“æ˜ç´°å–®ä½ï¼Œå„ªå…ˆä½¿ç”¨ä½¿ç”¨è€…é¸çš„
  const shipUnit = selectedUnit || product.unit;

  const conv = getConvertedInfo(qty, shipUnit);

  cart.push({
    id: product.id,
    name: product.name,
    price: product.price,
    qty: qty,
    priceUnit: shipUnit,       // âœ… ä½¿ç”¨è€…é¸æ“‡çš„å–®ä½
    shipQty: qty,
    shipUnit: shipUnit,
    convertQty: conv.qty,
    convertUnitName: conv.unit
  });

  // é‡ç½®æ¬„ä½
  productNameInput.value = '';
  document.getElementById('qty').value = 1;
  if (unitSelect) unitSelect.value = '';

  renderCart();
}

// æ›´æ–°å‡ºè²¨å–®ä½
function updateShipUnit(idx, value) {
  const unit = value.trim();
  if (!unit) return;

  cart[idx].shipUnit = unit;
  cart[idx].priceUnit = unit;  // âœ… åŒæ­¥æ›´æ–° priceUnit

  const conv = getConvertedInfo(cart[idx].shipQty, unit);
  cart[idx].convertQty = conv.qty;
  cart[idx].convertUnitName = conv.unit;

  renderCart();
}

// æ›´æ–°å‡ºè²¨æ•¸é‡
function updateShipQty(idx, value) {
  const v = parseFloat(value);
  if (isNaN(v) || v < 0) return;
  cart[idx].shipQty = v;

  const conv = getConvertedInfo(v, cart[idx].shipUnit);
  cart[idx].convertQty = conv.qty;
  cart[idx].convertUnitName = conv.unit;

  renderCart();
}

// æ›´æ–°å–®åƒ¹
function updatePrice(idx, value) {
  const v = parseFloat(value);
  if (isNaN(v) || v < 0) return;
  cart[idx].price = v;
  renderCart();
}

// ç·¨è¼¯åˆ‡æ›
function toggleEdit(index) {
  editingIndex = editingIndex === index ? null : index;
  renderCart();
}

// åˆªé™¤å•†å“
function removeItem(idx) {
  cart.splice(idx, 1);
  editingIndex = null;
  renderCart();
}

// è¨ˆç®—æ›ç®—æ•¸é‡
function getConvertedInfo(shipQty, shipUnit) {
  if (!shipUnit) return { qty: shipQty, unit: '' };
  let convertedQty = shipQty;
  let convertedUnit = shipUnit;

  if (shipUnit === 'å…¬æ–¤') {
    convertedQty = shipQty * 1.6667;
    convertedUnit = 'å°æ–¤';
  } else if (shipUnit === 'æ–¤' || shipUnit === 'å°æ–¤') {
    convertedQty = shipQty;
    convertedUnit = 'å°æ–¤';
  }

  return { qty: parseFloat(convertedQty.toFixed(4)), unit: convertedUnit };
}

// æ¸²æŸ“è³¼ç‰©è»Š
function renderCart() { 
  const tbody = document.getElementById('cartBody');
  tbody.innerHTML = '';

  let rawTotal = 0;
  const taxRate = 0.05;
  const isTaxable = document.getElementById('taxable_yes').checked;

  cart.forEach((item, idx) => {
    const price = parseFloat(item.price) || 0;
    const orderQty = parseFloat(item.qty) || 0;
    const shipQty = parseFloat(item.shipQty) || 0;

    // è¨ˆç®—æ›ç®—é‡
    const conv = getConvertedInfo(shipQty, item.shipUnit);
    item.convertQty = conv.qty;
    item.convertUnitName = conv.unit;

    const subtotal = Math.round(price * shipQty);
    rawTotal += subtotal;

    const isEditing = (editingIndex === idx);

    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${item.name}</td>
      <td>${orderQty}</td>
      <td>
        <input type="text" list="unitList" value="${item.shipUnit}" 
               ${isEditing ? '' : 'disabled'}
               onchange="updateShipUnit(${idx}, this.value)"
               style="width: 100%; font-size: 16px; padding: 4px;" />
      </td>
      <td>
        <input type="number" step="0.01" value="${price.toFixed(2)}"
          onchange="updatePrice(${idx}, this.value)" ${isEditing ? '' : 'disabled'}
          style="width: 100px; font-size: 16px; padding: 4px;" />
      </td>
      <td>
        <input type="number" min="0" step="1" value="${shipQty}"
          onchange="updateShipQty(${idx}, this.value)" ${isEditing ? '' : 'disabled'}
          style="width: 100px; font-size: 16px; padding: 4px;" />
      </td>
      <td>${conv.qty}</td>
      <td>${conv.unit}</td>
      <td>${subtotal}</td>
      <td>
        <div style="display: flex; gap: 4px; justify-content: center;">
          <button onclick="toggleEdit(${idx})" style="flex: 1; min-width: 40px;">${isEditing ? 'å®Œæˆ' : 'ç·¨è¼¯'}</button>
          <button onclick="removeItem(${idx})" style="flex: 1; min-width: 40px;">åˆªé™¤</button>
        </div>
      </td>
    `;
    tbody.appendChild(tr);
  });

  const roundedRawTotal = Math.round(rawTotal);
  document.getElementById('rawTotal').textContent = roundedRawTotal.toFixed(0);

  const discount = parseFloat(document.getElementById('discount').value) || 0;
  const afterDisc = roundedRawTotal - discount;
  const tax = isTaxable ? Math.round(afterDisc * taxRate) : 0;
  const grand = afterDisc + tax;

  // æ›´æ–°ç¨…é‡‘æ¬„ä½
  const taxAmountElem = document.getElementById('taxAmount');
  if (taxAmountElem.tagName === 'INPUT') {
    taxAmountElem.value = tax.toFixed(0);
  } else {
    taxAmountElem.textContent = tax.toFixed(0);
  }

  document.getElementById('grandTotal').textContent = grand.toFixed(0);
}


function submitOrder() {
  if (cart.length === 0) {
    alert('è³¼ç‰©è»Šç‚ºç©º');
    return;
  }

  const btn = document.getElementById('saveBtn'); // å‡è¨­ä½ çš„æŒ‰éˆ• id="saveBtn"
  const originalText = btn.innerText;
  btn.disabled = true;
  btn.innerText = 'ğŸ’¾ å„²å­˜ä¸­...';

  // è™•ç†è³¼ç‰©è»Šï¼Œä¿ç•™æ›ç®—è³‡è¨Š
  const itemsWithExtra = cart.map(item => {
    const shipQty = parseFloat(item.shipQty) || 0;
    const price = parseFloat(item.price) || 0;
    const conv = getConvertedInfo(shipQty, item.shipUnit || item.priceUnit);

    return {
      ...item,
      shipQty,
      convertQty:
        (item.convertQty !== undefined && item.convertQty !== null)
          ? parseFloat(item.convertQty)
          : conv.qty,
      convertUnitName: item.convertUnitName || conv.unit,
      subtotal: Math.round(price * shipQty)
    };
  });

  const order = {
    orderId: currentOrder ? currentOrder.orderId : null,
    mode: currentOrder && currentOrder.mode ? currentOrder.mode : '',
    client: document.getElementById('clientInput').value,
    invoiceNumber: document.getElementById('invoiceNumber').value,
    contact: document.getElementById('contact').value,
    mobile: document.getElementById('mobile').value,
    tel: document.getElementById('tel').value,
    clientAddress: document.getElementById('clientAddress').value,
    paymentMethod: document.getElementById('paymentMethod').value,
    paymentDays: parseInt(document.getElementById('paymentDays').value) || 0,
    paymentDate: document.getElementById('paymentDate').value,
    salesperson: document.getElementById('salesperson').value,
    tripNumber: document.getElementById('tripNumber').value,
    email: document.getElementById('email').value,
    items: itemsWithExtra,
    discount: parseFloat(document.getElementById('discount').value) || 0,
    taxable: document.querySelector('input[name="taxable"]:checked').value === 'yes',
    rawTotal: parseFloat(document.getElementById('rawTotal').textContent) || 0,
    grandTotal: parseFloat(document.getElementById('grandTotal').textContent) || 0,
    creator: document.getElementById('creatorInput')
      ? document.getElementById('creatorInput').value
      : ''
  };

  google.script.run
    .withSuccessHandler(res => {
      btn.innerText = originalText; // å„²å­˜æˆåŠŸæ¢å¾©æŒ‰éˆ•æ–‡å­—
      btn.disabled = false;

      if (res.success) {
        alert('âœ… è¨‚å–®å·²å„²å­˜æˆåŠŸï¼éŠ·è²¨å–®è™Ÿï¼š' + res.orderId);
        currentOrder = { ...order, orderId: res.orderId, mode: '' };
        const orderIdField = document.getElementById('orderIdDisplay');
        if (orderIdField) orderIdField.value = res.orderId;
      } else {
        alert('âŒ å„²å­˜å¤±æ•—ï¼š' + res.message);
      }
    })
    .withFailureHandler(err => {
      btn.innerText = originalText; // å¤±æ•—ä¹Ÿæ¢å¾©æŒ‰éˆ•æ–‡å­—
      btn.disabled = false;
      alert('âš ï¸ å„²å­˜è¨‚å–®å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
      console.error(err);
    })
    .saveOrder(order);
}

function searchOrder() {
  const oid = document.getElementById('searchOrderId').value.trim();
  if (!oid) {
    alert('è«‹è¼¸å…¥è¨‚å–®ç·¨è™Ÿ');
    return;
  }
  searchOrderById(oid);
}


function searchOrderById(oid) {  
  google.script.run
    .withSuccessHandler(data => {
      if (!data) {
        document.getElementById('orderResultMessage').textContent = 'æŸ¥ç„¡æ­¤è¨‚å–®';
        document.getElementById('orderResultMessage').style.display = 'block';
        document.getElementById('orderResultData').style.display = 'none';
        return;
      }

      // -------------------------
      // âœ… åŸºæœ¬è³‡æ–™
      // -------------------------
      currentOrder = data;
      currentOrder.orderId = data['éŠ·è²¨å–®è™Ÿ'] || '';

      // æ—¥æœŸæ ¼å¼æ•´ç†ï¼ˆYYYY-MM-DDï¼‰
      let ds = data['è¨‚å–®æ—¥æœŸ'] || data['dateStr'] || '';
      if (ds) {
        const datePart = ds.split(' ')[0];
        const parts = datePart.split('/');
        if (parts.length === 3) {
          ds = `${parts[0].padStart(4,'0')}-${parts[1].padStart(2,'0')}-${parts[2].padStart(2,'0')}`;
        } else ds = '';
      } else {
        const today = new Date();
        ds = `${today.getFullYear()}-${(today.getMonth()+1).toString().padStart(2,'0')}-${today.getDate().toString().padStart(2,'0')}`;
      }

      // -------------------------
      // âœ… å¡«å…¥è¡¨å–®æ¬„ä½
      // -------------------------
      document.getElementById('orderIdDisplay').value = data['éŠ·è²¨å–®è™Ÿ'] || '';
      document.getElementById('orderDateInput').value = ds;
      document.getElementById('clientInput').value = data['å®¢æˆ¶åç¨±'] || '';
      document.getElementById('invoiceNumber').value = data['çµ±ä¸€ç·¨è™Ÿ'] || '';
      document.getElementById('contact').value = data['è¯çµ¡äºº'] || '';
      document.getElementById('mobile').value = data['æ‰‹æ©Ÿ'] || '';
      document.getElementById('tel').value = data['å…¬å¸é›»è©±'] || '';
      document.getElementById('clientAddress').value = data['åœ°å€'] || '';
      document.getElementById('paymentMethod').value = data['çµæ¬¾æ–¹å¼'] || '';
      document.getElementById('paymentDays').value = data['æœˆçµå¤©æ•¸'] || '';
      document.getElementById('paymentDate').value = data['çµæ¬¾æ—¥'] || '';
      document.getElementById('salesperson').value = data['æ¥­å‹™å“¡'] || '';
      document.getElementById('tripNumber').value = data['è»Šæ¬¡'] || '';
      document.getElementById('email').value = data['E-Mail'] || '';
      document.getElementById('discount').value = data['æŠ˜æ‰£'] || 0;
      document.getElementById('creatorInput').value = data['USER'] || '';
      // -------------------------
      // âœ… å¡«å…¥è¡¨å–®æ¬„ä½
      // -------------------------
      document.getElementById('orderIdDisplay').value = data['éŠ·è²¨å–®è™Ÿ'] || '';
      document.getElementById('orderDateInput').value = ds;
      document.getElementById('clientInput').value = data['å®¢æˆ¶åç¨±'] || '';
      document.getElementById('invoiceNumber').value = data['çµ±ä¸€ç·¨è™Ÿ'] || '';
      document.getElementById('contact').value = data['è¯çµ¡äºº'] || '';
      document.getElementById('mobile').value = data['æ‰‹æ©Ÿ'] || '';
      document.getElementById('tel').value = data['å…¬å¸é›»è©±'] || '';
      document.getElementById('clientAddress').value = data['åœ°å€'] || '';
      document.getElementById('paymentMethod').value = data['çµæ¬¾æ–¹å¼'] || '';
      document.getElementById('paymentDays').value = data['æœˆçµå¤©æ•¸'] || '';
      document.getElementById('paymentDate').value = data['çµæ¬¾æ—¥'] || '';
      document.getElementById('salesperson').value = data['æ¥­å‹™å“¡'] || '';
      document.getElementById('tripNumber').value = data['è»Šæ¬¡'] || '';
      document.getElementById('email').value = data['E-Mail'] || '';
      document.getElementById('discount').value = data['æŠ˜æ‰£'] || 0;
      document.getElementById('creatorInput').value = data['USER'] || '';

      // ---------- èª²ç¨…åˆ¤æ–· & ç¨…é‡‘ ----------
      const taxAmount = parseFloat(data['çµå¸³ç¨…é‡‘'] || 0);
      const isTaxable = taxAmount > 0; // å¤§æ–¼0èª²ç¨…ï¼Œ0å°±æ˜¯å…ç¨…

      document.getElementById('taxable_yes').checked = isTaxable;
      document.getElementById('taxable_no').checked = !isTaxable;
      document.getElementById('taxAmount').textContent = taxAmount.toFixed(0);

      // -------------------------
      // âœ… å•†å“æ˜ç´°
      // -------------------------
      if (Array.isArray(data.details) && data.details.length > 0) {
        cart = data.details.map(it => {
          const qty = parseFloat(it['æ•¸é‡'] || it.qty) || 0;
          const price = parseFloat(it['å–®åƒ¹'] || it.price) || 0;
          const priceUnit = it['è¨ˆåƒ¹å–®ä½'] || it.priceUnit || '';
          const shipQty = parseFloat(it['å‡ºè²¨æ•¸é‡'] || it.shipQty) || 0;
          const convertQty = parseFloat(it['æ›ç®—æ•¸é‡'] || it.convertQty) || shipQty;
          const convertUnitName = it['æ›ç®—å–®ä½'] || it.convertUnitName || priceUnit;
          const subtotal = parseFloat(it['é‡‘é¡å°è¨ˆ'] || it.subtotal) || (shipQty * price);

          return {
            id: it.id || '',
            name: it['å•†å“åç¨±'] || it.name || '',
            price: price,
            qty: qty,
            shipQty: shipQty,
            priceUnit: priceUnit,
            shipUnit: priceUnit,
            convertQty: convertQty,
            convertUnitName: convertUnitName,
            subtotal: subtotal,
            salesperson: it.salesperson || '',
            tripNumber: it.tripNumber || '',
            supplier: it.supplier || '',
            key: it.key || ''
          };
        }).filter(it => it.qty > 0);
      } else {
        cart = [];
      }

      // -------------------------
      // âœ… é‡æ–°æ¸²æŸ“ç•«é¢
      // -------------------------
      renderCart();
      document.getElementById('orderResultMessage').style.display = 'none';
      document.getElementById('orderResultData').style.display = 'block';
    })
    .withFailureHandler(err => {
      alert('æŸ¥è©¢è¨‚å–®æ™‚ç™¼ç”ŸéŒ¯èª¤: ' + err.message);
      console.error(err);
    })
    .getOrderData(oid);
}



  function resetForm() {
      currentOrder = null;
      document.getElementById('orderIdDisplay').value = '';
      const today = new Date();
      const iso = today.toISOString().slice(0, 10);
      document.getElementById('orderDateInput').value = iso;

      document.getElementById('clientInput').value = '';
      document.getElementById('invoiceNumber').value = '';
      document.getElementById('email').value = '';
      document.getElementById('contact').value = '';
      document.getElementById('mobile').value = '';
      document.getElementById('tel').value = '';
      document.getElementById('clientAddress').value = '';
      document.getElementById('paymentMethod').value = '';
      document.getElementById('paymentDays').value = '';
      document.getElementById('paymentDate').value = '';
      document.getElementById('salesperson').value = '';
      document.getElementById('tripNumber').value = '';
      document.getElementById('discount').value = '0';
      document.getElementById('taxable_yes').checked = true;
      document.getElementById('creatorInput').value = '';


      cart = [];
      renderCart();
    }

  function copyOrder() {
  if (!currentOrder) {
    alert('ç›®å‰æ²’æœ‰è¨‚å–®å¯è¤‡è£½');
    return;
  }

  // é€²å…¥è¤‡è£½æ¨¡å¼
  currentOrder.mode = 'copy';

  // æç¤ºä½¿ç”¨è€…æ–°å–®è™Ÿå°‡æ–¼å„²å­˜æ™‚è‡ªå‹•ç”¢ç”Ÿ
  const orderIdField = document.getElementById('orderIdDisplay');
  if (orderIdField) orderIdField.value = '(æ–°å–®è™Ÿå¾…ç”¢ç”Ÿ)';

  alert('âœ… å·²é€²å…¥è¤‡è£½æ¨¡å¼ï¼Œè«‹ä¿®æ”¹å¿…è¦æ¬„ä½å¾ŒæŒ‰ã€Œå„²å­˜è¨‚å–®ã€ã€‚');
}

  function deleteCurrentOrder() {
    if (!currentOrder) {
      alert('ç„¡è¨‚å–®å¯åˆªé™¤');
      return;
    }
    if (confirm('ç¢ºå®šåˆªé™¤æ­¤è¨‚å–®ï¼Ÿ')) {
      google.script.run.withSuccessHandler(() => {
        alert('è¨‚å–®å·²åˆªé™¤');
        resetForm();
        currentOrder = null;
      }).deleteOrder(currentOrder.orderId);
    }
  }

// ---------------------------
// å¿«æ·éµå°æ‡‰å‡½å¼è¡¨
// ---------------------------
const hotkeys = {
  F1: () => {
    createNewOrder();
    setTimeout(() => {
      const creatorInput = document.getElementById('creatorInput');
      if (creatorInput) {
        creatorInput.focus();
        creatorInput.select?.();
      }
    }, 200);
  },
  F2: () => {
    const productInput = document.getElementById('productInput');
    if (productInput) {
      productInput.focus();
      productInput.select();
    }
  },
  F3: () => toggleClientEdit(),
  F4: () => copyOrder(),
  F5: () => deleteCurrentOrder(),
  F6: () => resetForm(),
  F7: () => printOrder(),
  F8: () => submitOrder(),
  F9: () => {
    const searchInput = document.getElementById('searchOrderId');
    if (searchInput) {
      searchInput.focus();
      searchInput.select();
    }
  },
  F10: () => searchOrder(),
  F12: () => addSelectedProduct()
};

// ---------------------------
// å…¨åŸŸå¿«æ·éµç›£è½
// ---------------------------
document.addEventListener('keydown', function(event) {
  const handler = hotkeys[event.key];
  if (handler) {
    event.preventDefault(); // é˜»æ­¢ç€è¦½å™¨é è¨­è¡Œç‚º
    handler();              // åŸ·è¡Œå°æ‡‰å‡½å¼
  }
});

function printOrder(mode = 'SHORT') {  
  if (!currentOrder && cart.length === 0) {
    alert('ç›®å‰æ²’æœ‰è¨‚å–®å¯åˆ—å°');
    return;
  }

  // === è™•ç†å–®ä½è³‡æ–™ ===
  cart.forEach(item => {
    if (!item.shipUnit || item.shipUnit.trim() === '') {
      item.shipUnit = item.priceUnit || '';
    }
    item.unitForConv = item.shipUnit;
  });

  document.querySelectorAll('#cartBody tr').forEach((row, idx) => {
    const unitCell = row.querySelector('td:nth-child(4)');
    const weightUnitSelect = row.querySelector('select');
    if (unitCell) cart[idx].priceUnit = unitCell.textContent.trim();
    if (weightUnitSelect) cart[idx].weightUnit = weightUnitSelect.value.trim();
    cart[idx].unitForConv = cart[idx].shipUnit || cart[idx].priceUnit || '';
  });

  // === é©—è­‰å•†å“è³‡æ–™ ===
  for (let i = 0; i < cart.length; i++) {
    const item = cart[i];
    if (!item.name || item.price <= 0 || (!item.qty && !item.weight)) {
      alert(`ç¬¬ ${i + 1} é …å•†å“è³‡æ–™ä¸å®Œæ•´ï¼Œè«‹ç¢ºèªå•†å“åç¨±ã€åƒ¹æ ¼èˆ‡æ•¸é‡/ç§¤é‡`);
      return;
    }
  }

  // === å–å¾—å…¬å¸è³‡æ–™ ===
  google.script.run
    .withSuccessHandler(companyInfo => {
      const companyName = companyInfo.name || 'å…¬å¸åç¨±æœªè¨­å®š';
      const companyTel = companyInfo.tel || 'é›»è©±æœªè¨­å®š';
      const orderDate = document.getElementById('orderDateInput')?.value || '';
      const orderId = document.getElementById('orderIdDisplay')?.value || 'æœªå‘½åå–®è™Ÿ';
      const clientName = document.getElementById('clientInput')?.value || '';
      const invoice = document.getElementById('invoiceNumber')?.value || '';
      const user = document.getElementById('creatorInput')?.value || 'æœªå¡«å¯«';
      const mobile = document.getElementById('mobile')?.value || '';
      const contact = document.getElementById('contact')?.value || '';
      const salesperson = document.getElementById('salesperson')?.value || '';
      const address = document.getElementById('clientAddress')?.value.replace(/\n/g, ' ') || '';
      const discount = parseFloat(document.getElementById('discount')?.value) || 0;
      const paymentMethod = document.getElementById('paymentMethod')?.value || '';
      const isTax = document.getElementById('taxable_yes')?.checked || false;
      const taxRate = 0.05;
      const prepayment = parseFloat(document.getElementById('prepayment')?.value) || 0;

      // === è¨ˆç®—å°è¨ˆ ===
      let rawTotal = 0;
      const items = cart.map((item, index) => {
        const price = Math.round(parseFloat(item.price) || 0);
        const shipQty = parseFloat(item.shipQty) || 0;
        const subtotal = Math.round(price * shipQty);
        rawTotal += subtotal;
        return {
          html: `
            <tr>
              <td class="serial">${index + 1}</td>
              <td>${item.name}</td>
              <td class="right">${shipQty}</td>
              <td>${item.unitForConv || ''}</td>
              <td class="right">${price}</td>
              <td class="right">${item.convertQty || ''}</td>
              <td>${item.convertUnitName || ''}</td>
              <td class="right">${subtotal}</td>
            </tr>
          `,
          subtotal
        };
      });

      const afterDiscount = Math.round(rawTotal - discount);
      const tax = isTax ? Math.round(afterDiscount * taxRate) : 0;
      const total = Math.round(afterDiscount + tax);

      // === é é¢æ¨¡æ¿ ===
      const pageHeader = (pageNum) => `
        <h1>${companyName}</h1>
        <h2>éŠ·è²¨å–®</h2>
        <div class="line3">
          <div>éŠ·è²¨æ—¥æœŸ : ${orderDate}</div>
          <div>å–®è™Ÿ : ${orderId}</div>
          <div>é€£çµ¡é›»è©± : ${companyTel}</div>
        </div>
        <div class="customer-box">
          <div class="customer-row">
            <div>å®¢æˆ¶åç¨± : ${clientName}</div>
            <div>å®¢æˆ¶çµ±ç·¨ : ${invoice}</div>
            <div>è£½å–®äººå“¡ : ${user}</div>
          </div>
          <div class="customer-row">
            <div>è¯çµ¡äºº : ${contact}</div>
            <div>é›»è©± : ${mobile}</div>
            <div>æ¥­å‹™ : ${salesperson}</div>
          </div>
          <div class="customer-address">é€è²¨åœ°å€ : ${address}</div>
        </div>
        <table>
          <thead>
            <tr>
              <th class="serial">åºè™Ÿ</th>
              <th>å“å</th>
              <th>æ•¸é‡</th>
              <th>å–®ä½</th>
              <th>å–®åƒ¹</th>
              <th>æ›ç®—æ•¸é‡</th>
              <th>æ›ç®—å–®ä½</th>
              <th>å°è¨ˆ</th>
            </tr>
          </thead>
          <tbody>
      `;

      const pageFooter = (pageNum, totalPages) => `
          </tbody>
        </table>
        <div class="page-number">ç¬¬ ${pageNum} é  / å…± ${totalPages} é </div>
      `;

      // === åˆ†é é‚è¼¯ (æ¯é  10 åˆ—å•†å“) ===
      const itemsPerPage = 10;
      const totalPages = Math.ceil(items.length / itemsPerPage);
      let pagesHTML = '';

      for (let p = 0; p < totalPages; p++) {
        const start = p * itemsPerPage;
        const end = start + itemsPerPage;
        const pageItems = items.slice(start, end).map(i => i.html).join('');
        const isLast = p === totalPages - 1;

        const footerExtra = isLast ? `
          <div class="footer">
            <div class="footer-left">
              <div>å‚™è¨»: _______________________________</div>
              <div>ä»˜æ¬¾æ–¹å¼: ${paymentMethod}</div>
              ${prepayment > 0 ? `<div>é æ”¶è¨‚é‡‘: ${Math.round(prepayment)} å…ƒ</div>` : ''}
              <div class="signature">ç°½æ”¶äºº: ____________________</div>
              <div>${companyInfo.note || 'é€è²¨å–®ä¸‰æ—¥æœ‰æ•ˆ'}</div>
            </div>
            <div class="footer-right" style="text-align: right;">
              <div>åˆè¨ˆ : ${rawTotal} å…ƒ</div>
              ${discount > 0 ? `<div>æŠ˜æ‰£ : ${Math.round(discount)} å…ƒ</div>` : ''}
              ${tax > 0 ? `<div>ç¨…é‡‘ : ${tax} å…ƒ</div>` : ''}
              <div class="total">ç¸½è¨ˆ : ${total} å…ƒ</div>
            </div>
          </div>
        ` : '';

        pagesHTML += `
          <div class="page">
            ${pageHeader(p + 1)}
            ${pageItems}
            ${pageFooter(p + 1, totalPages)}
            ${footerExtra}
          </div>
        `;
      }

      // === å›ºå®šé é¢é«˜åº¦ 140mm ===
      const pageHeight = '140mm';

const html = `
<html>
<head>
  <title>${orderId}</title>
  <style>
  @page {
    size: 210mm 140mm;   /* ä¸­ä¸€åˆ€ç´™å¼µå°ºå¯¸ */
    margin: 5mm;          /* å¯æ ¹æ“šéœ€è¦èª¿æ•´ */
  }

  body {
    font-family: "Microsoft JhengHei", sans-serif;
    font-size: 13px;
    margin: 0;
    padding: 0;
    width: 210mm;
    height: 140mm;
    box-sizing: border-box;
    overflow: hidden;
  }

  .page {
    width: 100%;
    height: 140mm;
    box-sizing: border-box;
    overflow: hidden;
    page-break-after: always;
    position: relative;
    border: 1px dashed #ccc; /* å¯é¸ï¼Œåƒ…é¡¯ç¤ºè™›ç·šæ¡† */
  }

  .page-number {
    position: absolute;
    bottom: 2mm;
    right: 2mm;
    font-size: 12px;
  }

  h1 { font-size: 20px; text-align: center; margin: 0; }
  h2 { font-size: 22px; text-align: center; margin: 4px 0; }

  
  .line3 { display: flex; justify-content: space-between; margin-bottom: 4px; }
  .line3 > div { width: 33%; text-align: center; }

  .customer-box {
      border-left: 1px solid #000;
      border-right: 1px solid #000;
      border-top: 1px solid #000;
      border-bottom: none;
      padding: 6px;
      margin: 6px 0 0 0;
      box-sizing: border-box;
    }

    .customer-row { display: flex; justify-content: space-between; margin-bottom: 4px; }
    .customer-row div { width: 32%; }
    .customer-address { word-break: break-all; }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
      word-break: break-word;
      border-left: 1px solid #000;
      border-right: 1px solid #000;
      border-top: none;
    }

  thead { display: table-header-group; }
  tr { page-break-inside: avoid; }
  th, td { border: 1px solid #000; padding: 3px 6px; }
  th { background: #eee; }
  .serial { width: 10mm; text-align: center; }
  .right { text-align: right; }

  .footer {
    font-size: 13px;
    border-left: 1px solid #000;
    border-right: 1px solid #000;
    border-top: none;
    border-bottom: 1px solid #000;
    margin-top: 0;
    padding: 6px;
    display: flex;
    justify-content: space-between;
    box-sizing: border-box;
  }
  .footer-left, .footer-right { width: 48%; }
  .total { font-weight: bold; font-size: 15px; }

  @media print { html, body { zoom: 0.96; } }
</style>

  <script>
    window.onload = function() { window.print(); };
    window.onafterprint = function() { window.close(); };
  <\/script>
</head>
<body>
  ${pagesHTML}
</body>
</html>
`;


      // === é–‹æ–°è¦–çª—åˆ—å° ===
      const printWindow = window.open('', '_blank');
      printWindow.document.open();
      printWindow.document.write(html);
      printWindow.document.close();
      printWindow.focus();
    })
    .getCompanyInfo();
}


    window.onload = () => {
      loadClients();
      loadProducts();
      resetForm();
      loadCreators();
      document.getElementById('discount').addEventListener('input', renderCart);
      document.getElementById('taxable_yes').addEventListener('change', renderCart);
      document.getElementById('taxable_no').addEventListener('change', renderCart);
      function loadCreators() {
  google.script.run.withSuccessHandler(data => {
    const datalist = document.getElementById('creatorList');
    datalist.innerHTML = '';
    data.forEach(name => {
      const opt = document.createElement('option');
      opt.value = name;
      datalist.appendChild(opt);
    });
  }).getAllCreators();
}
    };
  </script>
</body>
</html>
