<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>å¥‡å¯æ™ºèƒ½æ‰“å¡ç³»çµ±</title>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

<style>
body { 
    font-family: Arial; 
    background:#f7f7f7;
    display:flex; 
    justify-content:center; 
    padding:25px; 
    margin:0;
}
.card {
    background:white;
    width:95%;
    max-width:480px;
    box-shadow:0 8px 25px rgba(0,0,0,0.12);
    border-radius:18px;
    padding:25px 20px;
    display:flex;
    flex-direction:column;
    align-items:center;
    gap:20px;
}
#dateTime { font-size:22px; }
#userInfo { font-size:26px; font-weight:bold; }
#statusInfo { font-size:20px; padding:6px 18px; border-radius:30px; display:inline-block; font-weight:bold;}
.buttons-container { width:100%; display:flex; gap:12px;}
button { flex:1; padding:12px 0; font-size:20px; border-radius:10px; cursor:pointer; font-weight:bold; border:none; transition:0.22s;}
button:hover { transform: translateY(-3px); box-shadow: 0 8px 14px rgba(0,0,0,0.12);}
#btnStart { background:linear-gradient(145deg, #3498db, #2980b9); color:white; }
#btnEnd { background:linear-gradient(145deg, #2ecc71, #27ae60); color:white; }
#countdownWrapper { width:130px; height:130px; position:relative; display:none; }
#circleProgress { fill:none; stroke-width:12; stroke-linecap:round; transform: rotate(-90deg); transform-origin: center;}
#countdownText { position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); font-weight:bold; font-size:18px;}
#todayRecords { width:100%; background:#fafafa; border-radius:12px; padding:15px; border:1px solid #ddd; font-size:18px;}
#btnApprove { margin-top:10px; padding:14px 20px; font-size:20px; border-radius:12px; background:linear-gradient(145deg,#8e44ad,#663399); color:white; width:100%; border:none; cursor:pointer; font-weight:bold; display:none;}
#btnApprove:hover { transform: translateY(-3px); box-shadow:0 8px 14px rgba(0,0,0,0.12);}
@media(max-width:420px){ button { font-size:18px; } #userInfo { font-size:22px; } #todayRecords { font-size:16px; } }
</style>
</head>
<body>

<div class="card">
    <div id="userInfo">æ­£åœ¨ç²å–ä½¿ç”¨è€…è³‡è¨Š...</div>
    <div id="statusInfo"></div>
    <div id="dateTime">è¼‰å…¥ä¸­â€¦</div>
    <div class="buttons-container">
        <button id="btnStart">ä¸Šç­</button>
        <button id="btnEnd">ä¸‹ç­</button>
    </div>
    <div id="countdownWrapper">
        <svg width="130" height="130">
            <circle id="circleProgress" cx="65" cy="65" r="55"></circle>
        </svg>
        <div id="countdownText">æ‰“å¡ä¸­...</div>
    </div>
    <div id="todayRecords">ä»Šæ—¥æ‰“å¡ç´€éŒ„ï¼š</div>
    <button id="btnApprove">è£œæ‰“å¡å¯©æ‰¹</button>
</div>

<script>
// ===== è¨­å®š =====
const API_ENDPOINT = "https://script.google.com/macros/s/AKfycbx4WtgG6eoXEiKDXRRKjDqkTxZ2NFbn3FINHOrvaNPrnKMEypeTyJ2Kl0qLOMiyEn4XeQ/exec";
const COMPANY_IPS  = ["1.34.128.50"];
const MANAGERS = ["U76174e2a9654ab2c7b1f037b28cb6c86","U7fdf4fbd467b9a93a23fac01ed03351b"];

// ===== æ—¥æœŸæ™‚é–“ =====
function updateDateTime() {
    const now = new Date();
    document.getElementById("dateTime").textContent =
        now.toLocaleString("zh-TW", { hour12:false });
}
setInterval(updateDateTime, 1000);
updateDateTime();

// ===== å–å¾— IP =====
async function getIP() {
    try { return (await (await fetch("https://api.ipify.org?format=json")).json()).ip; }
    catch { return ""; }
}

// ===== é¡¯ç¤ºä¸»ç®¡æŒ‰éˆ• =====
function showApproveButtonIfManager() {
    document.getElementById("btnApprove").style.display =
        MANAGERS.includes(window.userId) ? "block" : "none";
}

// ===== æ›´æ–°ä½¿ç”¨è€…è³‡è¨Š =====
async function updateUserInfo() {
    await liff.init({ liffId: "2008538866-zDXM53Ao" });
    if (!liff.isLoggedIn()) return liff.login();
    const profile = await liff.getProfile();
    window.userId = profile.userId;
    window.userName = profile.displayName;
    document.getElementById("userInfo").textContent = `${window.userName} æ‚¨å¥½`;
    showApproveButtonIfManager();
    const ip = await getIP();
    const s = document.getElementById("statusInfo");
    if (COMPANY_IPS.includes(ip)) {
        s.textContent = "å…¬å¸ç¶²è·¯";
        s.style.color = "#008000";
        s.style.backgroundColor = "rgba(144,238,144,0.6)";
    } else {
        s.textContent = "éå…¬å¸ç¶²è·¯";
        s.style.color = "#FF0000";
        s.style.backgroundColor = "rgba(255,182,193,0.3)";
    }
    s.style.padding = "5px 15px";
    s.style.borderRadius = "20px";
    s.style.display = "inline-block";
}

// ===== å€’æ•¸å‹•ç•« =====
function startAnimation() {
    const wrapper = document.getElementById("countdownWrapper");
    const circle = document.getElementById("circleProgress");
    wrapper.style.display = "block";
    const radius = 55;
    const circumference = 2 * Math.PI * radius;
    circle.style.strokeDasharray = circumference;
    let progress = 0;
    function anim() {
        progress += 0.015;
        if (progress > 1) progress = 1;
        circle.style.strokeDashoffset = circumference * (1 - progress);
        if (progress < 1) requestAnimationFrame(anim);
    }
    requestAnimationFrame(anim);
}

// ===== ä¿®æ­£æ™‚é–“æ ¼å¼ =====
function fixTimeFormat(t) {
    if (typeof t === "string" && t.includes(":")) return t;
    if (!isNaN(t)) {
        const d = new Date((t - 25569) * 86400 * 1000);
        return d.toLocaleTimeString("zh-TW", { hour12:false });
    }
    return t;
}

// ===== æ›´æ–°ä»Šæ—¥ç´€éŒ„ =====
async function updateTodayRecords() {
    const now = new Date();
    const today = now.toLocaleDateString("zh-TW").replace(/\//g, "/");
    try {
        const res = await fetch(`${API_ENDPOINT}?action=getToday&userId=${window.userId}&date=${today}`);
        const data = await res.json();
        const container = document.getElementById("todayRecords");
        if (!data.length) { container.innerHTML = "ä»Šæ—¥æ‰“å¡ç´€éŒ„ï¼šç„¡"; return; }
        container.innerHTML = "ä»Šæ—¥æ‰“å¡ç´€éŒ„ï¼š<br>" + data.map(r => {
            const time = fixTimeFormat(r.time);
            const ipLabel = COMPANY_IPS.includes(r.ip) ? "(æˆåŠŸ)" : "(éŒ¯èª¤-ç•°åœ°è«‹å¿½ç•¥)";
            const makeup = r.isMakeup ? "(è£œæ‰“å¡-å¯©æ ¸ä¸­)" : "";
            return `${r.status} ${time} ${ipLabel} ${makeup}`;
        }).join("<br>");
    } catch {
        document.getElementById("todayRecords").innerHTML = "ä»Šæ—¥æ‰“å¡ç´€éŒ„ï¼šè®€å–å¤±æ•—";
    }
}

// ===== æ‰“å¡åŠŸèƒ½ =====
async function performClockIn(status, customDate="", customTime="", isMakeup=false) {
    if (!window.userId || !window.userName) {
        Swal.fire({ icon: "info", title: "è«‹ç¨å€™", html: "æ­£åœ¨å–å¾— LINE ä½¿ç”¨è€…è³‡æ–™ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚", timer:2000, showConfirmButton:false });
        await updateUserInfo();
        return;
    }
    const ip = await getIP();
    document.getElementById("countdownText").textContent = isMakeup ? "è£œæ‰“å¡ä¸­..." : "æ‰“å¡ä¸­...";
    startAnimation();
    let data;
    try {
        const res = await fetch(API_ENDPOINT, {
            method: "POST",
            body: JSON.stringify({ userId: window.userId, displayName: window.userName, status, ip, customDate, customTime, isMakeup })
        });
        data = await res.json();
    } catch {
        data = { message:"å¤±æ•—" };
    }
    if(data.message.includes("æˆåŠŸ") && COMPANY_IPS.includes(ip)) {
        Swal.fire({ icon:"success", title:"ğŸ‰ æ‰“å¡æˆåŠŸï¼", html:`<strong>æ‰“å¡æ™‚é–“ï¼š</strong> ${data.date} ${data.time}`, showConfirmButton:false, timer:3500 });
    } else if(data.message.includes("æˆåŠŸ")) {
        Swal.fire({ icon:"warning", title:`âš  éå…¬å¸ç¶²è·¯`, html:`åˆ‡æ›ç¶²è·¯å†è©¦<br><br><b>â— ç•°åœ°æ‰“å¡è«‹å¿½ç•¥ â—</b>`, showConfirmButton:false, timer:3500 });
    } else {
        Swal.fire({ icon:"error", title:"ğŸ˜¥ ä»Šæ—¥å·²æ‰“å¡", html:"é‡è¤‡æ‰“å¡", showConfirmButton:false, timer:3000 });
    }
    setTimeout(()=>{ document.getElementById("countdownWrapper").style.display="none"; },300);
    updateTodayRecords();
}

// ===== æŒ‰éˆ•äº‹ä»¶ =====
document.getElementById("btnStart").onclick = ()=>performClockIn("ä¸Šç­");
document.getElementById("btnEnd").onclick = ()=>performClockIn("ä¸‹ç­");
document.getElementById("btnApprove").onclick = ()=>{ window.location.href="https://script.google.com/macros/s/AKfycbyxXrvVxfgwrI-SdXM03QEYxEpG-xqyjVQcxdNz1IBK3DtFC-kUFjHhRaNtgXNU-Mdu/exec"; };

// ===== åˆå§‹åŒ– =====
window.onload = async ()=>{ await updateUserInfo(); await updateTodayRecords(); };
</script>

</body>
</html>
































































































































